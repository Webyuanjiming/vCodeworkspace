app.controller('WkIndexController', ['$rootScope', '$scope', '$http', '$routeParams', '$location', 'GlobalBorrowInfo','baseService','commonService',
    function($rootScope, $scope, $http, $routeParams, $location, borrow,service,wkindex) {


        /*var path = $location.path();
        if (path.indexOf("product") == -1) {
            var active = "#FF6666";
            var hover = "#B1B3B5";
            var activetype = {
                "icon": "active",
                "color": active
            }
            var hovertype = {
                "icon": "hover",
                "color": hover
            }

            $rootScope.dl1 = activetype;
            $rootScope.dl2 = hovertype;
            $rootScope.dl3 = hovertype;
            $rootScope.dl4 = hovertype;
        }
        */
        setDefaultValue($scope, $rootScope);

        //月份类型:1 2 3 6 12
        if (isEmpty($scope.navType)) {
            $scope.navType = "one";
            $scope.showBorrowTypeNav = 0;
        }

        if (isEmpty($scope.borrowMap)) {
            $scope.borrowMap = {
                "one": null,
                "two": null,
                "three": null,
                "six": null,
                "twe": null
            };
        }

        /*=2016/07/08=+commonService=*/
        wkindex.loadAction({
          url: $rootScope.URL_ROOT + "/home/facade"
        },$scope).success(function(response){
            /*console.log(response);*/
            $scope.index_borrows = response.entity.borrows;
        });

        /*=2016/07/08=+commonService=*/
        wkindex.loadAction({
          url: $rootScope.URL_ROOT + "/home/facade"
        },$scope).success(function(response){
          //  console.log(response);
            $scope.img_borrows=response.entity.activities;
            //2016/07/11 控制主页推荐部分ng-repeat显示几个代码
            var arr =$scope.img_borrows;//附以老的数组
            //运算函数
              Array.prototype.random = function () {
                //随机抽取数组中一个元素
                var idx = Math.floor((Math.random()*this.length));
                //删除并替换元素
                var n = this.splice(idx,1)[0];
                return n;
              }
              //新建数组中元素从0开始
              var i = 0;
              var a = [];//新建一个数组
              while(i++<5){
                a.push(arr.random());//排序
              }
              //console.log(a);
        });

        $scope.formatData = function(data) {
            return convertToFloat(data).toFixed(2);
        }

        $scope.getBorrowType = function(borrow) {
            return getBorrowByType(borrow);
        }
        $scope.setRateMemo = function(borrow) {
            if (isEmpty(borrow)) return;
            var rate = borrow.borrowRate;

            var rateLength = rate.toString().length;
            if (!isEmpty(rate)) {
                if (rate.toString().length > 1) {
                    borrow.A = rate[0];
                    var tmpIndex = borrow.borrowRate.indexOf('.');
                    if (tmpIndex != -1) {
                        borrow.B = rate.substr(1, tmpIndex);
                        borrow.C = rate.substr(tmpIndex + 1, rateLength - tmpIndex);
                    } else if (rateLength > 1) {
                        borrow.B = rate[1];
                    }
                } else {
                    borrow.A = rate;
                }
            }
        }

        //导航类型
        $scope.typeChange = function(navType) {
                $scope.navType = navType;
                if (!isEmpty($scope.borrowMap)) {
                    var items = $scope.borrowMap[navType];
                    if (Array.isArray(items)) {
                        $scope.borrow = items[0];
                        $scope.showBorrowTypeNav = 1;
                    } else {
                        $scope.borrow = items; //此时为一个对象
                        $scope.showBorrowTypeNav = 0;
                    }
                    if (!isEmpty($scope.borrow)) {
                        $scope.setRateMemo($scope.borrow);
                    }
                }
            }
            //标类型
        $scope.borrowTypeChange = function(type) {
            $scope.showBorrowType = type;
            if (!isEmpty($scope.borrowMap)) {
                var items = $scope.borrowMap[$scope.navType];

                if (!isEmpty(items) && Array.isArray(items)) {
                    if (type == "U") {
                        $scope.borrow = items[0];
                    } else if (type = "N") {
                        $scope.borrow = items[1];
                    }
                }
                if (!isEmpty($scope.borrow)) {
                    $scope.setRateMemo($scope.borrow);
                }
            }
        }
        $scope.setBorrow = function(navType, borrow) {
            if (isEmpty(borrow)) return;
            if (isEmpty($scope.borrowMap[navType])) {
                $scope.borrowMap[navType] = borrow;
            } else {
                if (Array.isArray($scope.borrowMap[navType])) {
                    $scope.borrowMap[navType].push(borrow);
                } else {
                    var items = [];
                    items.push($scope.borrowMap[navType]);
                    $scope.borrowMap[navType] = items;
                }
            }
        }
        var channelBorrowId = (!isEmpty(borrow) && !isEmpty(borrow.borrowId)) ? borrow.borrowId : ((!isEmpty(localStorage) && !isEmpty(localStorage.getItem("CHANNEL_BORROWID")) ? localStorage.getItem("CHANNEL_BORROWID") : null));
        if ($routeParams.t == "rechage" && !isEmpty(channelBorrowId)) {

            if (!isEmpty(localStorage)) {
                localStorage.removeItem("CHANNEL_BORROWID");
            }
            if (!isEmpty(borrow)) {
                borrow.borrowId = null;
            }
            $location.url("borrowmed?id=" + channelBorrowId);
            return;
        }
        var whometUrl = $rootScope.URL_ROOT + "/whome"; //新版首页
        $rootScope.loading = true;
        $http.get(whometUrl).success(function(response) {
            if (checkResponse($rootScope, $scope, response)) {

                if (!isEmpty(response.borrows)) {
                    for (var index = 0; index < response.borrows.length; index++) {
                        var borrow = response.borrows[index];
                        var period = borrow.period;
                        switch (period) {
                            case "1":
                                $scope.setBorrow("one", borrow);
                                break;
                            case "2":
                                $scope.setBorrow("two", borrow);
                                break;
                            case "3":
                                $scope.setBorrow("three", borrow);
                                break;
                            case "6":
                                $scope.setBorrow("six", borrow);
                            case "12":
                                $scope.setBorrow("twe", borrow);
                                break;
                        }
                    }
                }
                //如果标都满了也会显示3个1个月，6个月，12个月
                var nav = {
                    "one": 0,
                    "two": 0,
                    "three": 0,
                    "six": 0,
                    "twe": 0
                };
                var navType;
                var borrowMap = $scope.borrowMap;
                if (!isEmpty(borrowMap)) {
                    var tabCount = 0; //控制tab页数量，最多有三个
                    for (var item in borrowMap) {
                        if (tabCount > 2) break;
                        if (!isEmpty(borrowMap[item])) {
                            if (isEmpty(navType)) {
                                navType = item;
                            }
                            nav[item] = 1;
                            tabCount++;
                        }
                    }
                }
                $scope.nav = nav;
                $scope.typeChange(navType);
                $scope.loginstatus = response.loginstatus;
                $scope.entity = response.entity;
                $scope.phone = response.phone;
                $scope.userId = response.userId;
                Share($scope, $rootScope, $http);
            }
        }).error(function(response, status, headers, config) {
            checkResponse($rootScope, $scope, response);
        });
    }
]);

/*
//选项切换
app.directive('jjClick', function($document) {
    return function($scope, element, attrs) {
        $('#ta li').bind('click', function() {
            $(this).addClass("activ").siblings('li').removeClass("activ");
        });
        $('#ta li p').each(function() {
            $(this).click(function() {
                $(this).addClass("p-active");
                $(this).parent().siblings("li").find("p").removeClass("p-active");
            });
        });
    }
});
*/



app.directive('navhandler', ['$location',
    function($location) {

        return {
            restrict: 'A',
            transclude: false,
            link: function() {

                var path = $location.path();

                if (path == "/") {
                    $("navTitle").hide();
                    $("navTool").hide();
                } else if (path.indexOf("product") != -1) {
                    $("navTitle").hide();
                    $("navTool").hide();
                } else {
                    $("navTitle").show();
                    $("navTool").show();
                }
            }
        };

    }
]);

//我的账户相关的控制器,个人账户信息概况
//现在会执行两次需要优化
app.controller('waccountController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location', 'baseService', 'AccountInfo',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location, service, account) {

        if (!preMultiExec($scope)) return;
        service.initValue($scope);

        $scope.div_show = false;
        $scope.zone = null;


        $scope.show = function() {
            if ($("#masking").length > 0) {
                $("#masking").css('display', 'block');
                $scope.div_show = true;
            } else {
                var masking = document.createElement("div");
                masking.className = "masking-02";
                masking.style.display = "block";
                masking.id = "masking";

                /*var f_img = document.createElement("div");
                f_img.className = "f-img00";
                masking.appendChild(f_img);*/

                $scope.zone = $("#qrcodezone");
                $("#qrcodezone").remove();

                masking.appendChild($scope.zone[0]);
                $(document.body).append(masking);
                $scope.div_show = true;

                $(masking).click(function() {
                    $("#masking").css('display', 'none');
                });
            }
        }

        $scope.hide = function() {
            /*if ($("#masking").length > 0) {
                $("#masking").css('display', 'none');
            }*/
            $scope.div_show = false;
        }


        if (isEmpty($scope.showFlg)) {
            $scope.showFlg = 0; //是否显示人民币标识
        }


        var url = service.makeUrl("/default");

        service.loadEntity(url, $scope, "entity", function(response) {

            $rootScope.entity = $scope.entity;
            account.data = $rootScope.entity;
            //数据格式化
            /*$scope.entity.account.coin = convertToFloat($scope.entity.account.coin).toFixed(2);
            $scope.entity.account.totalCapital = convertToFloat($scope.entity.account.totalCapital).toFixed(2);
            $scope.entity.account.frost = convertToFloat($scope.entity.account.frost).toFixed(2);
            $scope.entity.account.balance = convertToFloat($scope.entity.account.balance).toFixed(2);
            $scope.entity.account.totalEarnings = convertToFloat($scope.entity.account.totalEarnings).toFixed(2);*/

            Share($scope, $rootScope, $http, $scope.entity.account.user.phoneNumber, $scope.entity.account.user.userId);
        });


        //安全退出
        $scope.logout = function() {

            var logoutUrl = service.makeUrl("/logout");

            service.execAction($scope, logoutUrl, function(object) {
                $location.url("/");
            });
        }

        $scope.showInterest = function() {
            if (isEmpty($scope.entity) || isEmpty($scope.entity.account)) {
                return true;
            }
            if ($scope.entity.account.interestFlg != 1) {
                return false;
            }
            if (isNaN($scope.entity.account.dayInterest)) {
                var array = ["谢天谢地您来了，别急，24小时之后再来看看",
                    "客官您稍后，收益要24小时之后呢",
                    "24小时之后收益才会呈现呢，淡定、淡定",
                    "服务器刚刚开始为您加速运转，需要24小时呢",
                    "Relax，24小时之后收益才跑到您的账户"
                ];
                var rand = Math.round(Math.random() * 10);
                if (rand >= array.length) {
                    var tmp = Math.round(rand % array.length);
                    if (tmp > array.length) {
                        rand = array.length - 1;
                    } else {
                        rand = tmp;
                    }
                }
                $scope.showFlg = 0;
                $scope.entity.account.dayInterest = array[rand];
            } else {
                $scope.showFlg = 1;
            }
            return true;

        }

        //开通余额生息
        $scope.OpInterest = function() {
            var joinInterestUrl = service.makeUrl("/joininterest");
            service.execAction($scope, joinInterestUrl, function(object) {
                $scope.entity.account.interestFlg = 1;
                $scope.showFlg = 0;
                $scope.showInterest();
            });
        }


    }
]);


//我的账户相关的控制器,个人账户信息概况
app.controller('InterestController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location) {

        var list = [];
        var url = $rootScope.URL_ROOT + "/getinterest";

        if ($scope.showInterest) {
            $scope.showInterest = 1;
        }

        $http.get(url).success(function(response) {
            if (checkResponse($rootScope, $scope, response)) {
                $scope.entity = response.entity;

                if (isNaN($scope.entity.dayInterest)) {
                    $scope.showInterest = 1;
                } else {
                    $scope.showInterest = 0;
                }

            }
        }).error(function(response, status, headers, config) {
            checkResponse($rootScope, $scope, response);
        });
    }
]);


//自动投标设置
app.controller('AutoInvestController', ['$rootScope', '$scope', '$http', '$location', 'baseService',
    function($rootScope, $scope, $http, $location, service) {

        if (!preMultiExec($scope)) return;
        service.initValue($scope, function() {


            if (isEmpty($scope.showFlg)) {
                $scope.showFlg = 0; //是否显示人民币标识
            }
            if (isEmpty($scope.curSettingPage)) {
                $scope.curSettingPage = 1; //记录设置的当前页数
                $scope.curInvesetPage = 1; //记录自动投标列表的页数


                $scope.curSetTotalPage = 1; //记录设置的当前页数
                $scope.curInvTotalPage = 1; //记录自动投标列表的页数
            }

            $scope.defaultSetting = null;

        });
        $scope.loadDefaultSetting = function() {
            var autoUrl = service.makeUrl("/setting/auto");
            service.loadEntity(autoUrl, $scope, "entity", function(response) {

                var entity = $scope.entity;

                $scope.entities = entity.settings.list;
                $scope.records = entity.records.list;

                $scope.curSetTotalPage = entity.settings.pageCount;
                $scope.curInvTotalPage = entity.records.pageCount;

                $scope.defaultSetting = entity.defaultSetting;

                if (isEmpty($scope.now)) {
                    $scope.now = service.clone($scope.entity.defaultSetting);
                }
            });
        }

        $scope.changeStatus = function(item) {
            if (isEmpty(item) || isEmpty(item.id)) {
                return;
            }
            var status = 1;
            if (!item.enable) {
                status = 0;
            }
            var url = service.makeUrl("/setting/statuschanged?id=" + item.id + "&status=" + status); //更新执行刷新操作
            service.execAction($scope, url, function(object) {
                //
            });
        }

        if (isEmpty($scope.now)) //当前操作的对象
        {
            $scope.loadDefaultSetting();
        }

        //列表状态改变
        //设置TODO:优化加载列表
        $scope.loadSetingMore = function() {

            if ($scope.curSettingPage < $scope.curSetTotalPage) {
                $scope.curSettingPage = $scope.curSettingPage + 1;

                var url = $rootScope.URL_ROOT + "/setting/getsetting?pi=" + $scope.curSettingPage + "&ps=5";

                $http.get(url).success(function(response) {
                    if (checkResponse($rootScope, $scope, response)) {

                        if (!isEmpty($scope.entities) && Array.isArray($scope.entities)) //列表中已有元素
                        {
                            var list = response.list;
                            list.forEach(function(item, index, array) {
                                $scope.entities.push(item);
                            });
                        } else {
                            $scope.entities = response.list;
                        }
                    }
                });
            }
        };

        //自动投标记录
        $scope.loadInvestMore = function() {
            if ($scope.curInvesetPage < $scope.curInvTotalPage) {
                $scope.curInvesetPage = $scope.curInvesetPage + 1;

                var url = $rootScope.URL_ROOT + "/setting/autorecord?pi=" + $scope.curInvesetPage + "&ps=5";
                $http.get(url).success(function(response) {
                    if (checkResponse($rootScope, $scope, response)) {
                        if (!isEmpty($scope.records) && Array.isArray($scope.records)) //列表中已有元素
                        {
                            var list = response.list;
                            list.forEach(function(item, index, array) {
                                $scope.records.push(item);
                            });
                        } else {
                            $scope.records = response.list;
                        }
                    }
                });
            }
        };

        //提交
        $scope.updateOrAddEntity = function() {

            var serviceUrl = service.makeUrl("/setting/autosetting");
            $scope.now.borrowType = $("#selBorrowType").val();
            if (isEmpty($scope.now.borrowType)) {
                $scope.now.borrowType = "2,7";
            }

            service.postAction($scope, serviceUrl, function(data, status) {
                if (isEmpty($scope.now.id)) //新增
                {
                    $scope.entities.unshift($scope.now); //在数组的第一个新增一个元素
                }
                //跳转回列表页
                $scope.Ui.set('activeTab', 1);
                $scope.Ui.turnOn('button1');
            }, $scope.now);
        }

        $scope.modify = function(item) {
            $scope.now = item;
            $("selBorrowType").val($scope.now.borrowType);
        }

        $scope.add = function(item) {
            $scope.now = $scope.defaultSetting;
        }

        $scope.delete = function(id) {

            var delUrl = service.makeUrl("/setting/delautoinvest?id=" + id);
            service.execAction($scope, delUrl, function(object) {
                for (var i = 0; i < $scope.entities.length; i++) {
                    if ($scope.entities[i].id == id) {
                        $scope.entities.splice(i, 1); //删除这个元素,不用从服务器重新获取
                    }
                };


            });
        }

    }
]);





//我的账户相关的控制器,个人账户信息概况
app.controller('TestController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location) {

        $scope.rememberMe = false;

        $scope.change = function() {
            $scope.rememberMe;
            console.log($scope.rememberMe);
        }

    }
]);


/**投资管理**/
app.controller('InvestinfoController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location', 'baseService',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location, service) {

        if (!preMultiExec($scope)) return;

        service.initValue($scope, $rootScope);
        var url = service.makeUrl("/tendersummary");
        service.loadEntity(url, $scope, "entity", function(response) {

            if (isEmpty($scope.entity.repayingAccount)) {
                $scope.entity.repayingAccount = "0.00";
            }

            if (isEmpty($scope.entity.tenderingAccount)) {
                $scope.entity.tenderingAccount = "0.00";
            }

            if (isEmpty($scope.entity.totalEarnings)) {
                $scope.entity.totalEarnings = "0.00";
            }
        });
    }
]);


/**聚金宝**/
app.controller('JuJinBaoController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location', 'baseService',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location, service) {

        if (!preMultiExec($scope)) return;

        service.initValue($scope, $rootScope);
        if ($scope.showInterest) {
            $scope.showInterest = 1;
        }

        if (isEmpty($scope.currentDetailPage)) {
            $scope.currentDetailPage = 1;
            $scope.currentZhaiQuanPage = 1;

            if (isEmpty($scope.totalDetailPage)) {
                $scope.totalDetailPage = 1;
            }
            if (isEmpty($scope.totalZhaiQuanPage)) {

                $scope.totalZhaiQuanPage = 1;
            }
        }


        var url = service.makeUrl("/getjujinbao");
        service.loadEntity(url, $scope, "entity", function(response) {
            $scope.entity = response.entity;

            if (isNaN($scope.entity.dayInterest)) {
                $scope.showInterest = 1;
            } else {
                $scope.showInterest = 0;
            }
            if (isEmpty($scope.details)) {
                $scope.details = $scope.entity.detail.list;
            }

            if (isEmpty($scope.zhaiquans)) {
                $scope.zhaiquans = $scope.entity.zhaiQuan.list;
            }

            $scope.totalZhaiQuanPage = $scope.entity.zhaiQuan.pageCount;
            $scope.totalDetailPage = $scope.entity.detail.pageCount;
        });
        $scope.loadDetailMore = function() {

            if ($scope.currentDetailPage < $scope.totalDetailPage) {
                $scope.currentDetailPage = $scope.currentDetailPage + 1;

                var url = service.makeUrl("/getjujinbaolist?pi=" + $scope.currentDetailPage + "&ps=5");
                service.loadEntities(url, $scope, "details");
            }

        };

        $scope.loadZhaiQuanMore = function() {

            if ($scope.currentZhaiQuanPage < $scope.totalZhaiQuanPage) {
                $scope.currentZhaiQuanPage = $scope.currentZhaiQuanPage + 1;

                var url = service.makeUrl("/getjujinbaozhaiquanlist?pi=" + $scope.currentZhaiQuanPage + "&ps=10");
                service.loadEntities(url, $scope, "zhaiquans");
            }
        };



    }
]);


/**
   函数名：AccountInfoController
   参数：
   说明：资金数据查看

   **/
app.controller('AccountInfoController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location', 'baseService', 'AccountInfo',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location, service, account) {
        $scope.entity = account.data;
    }
]);


/**
   函数名：AccountSetController
   参数：
   说明：账户设置

   **/
app.controller('AccountSetController', ['$rootScope', '$scope', '$http', '$routeParams', 'SharedState', '$location', 'baseService',
    function($rootScope, $scope, $http, $routeParamsp, SharedState, $location, service) {



    }
]);


/**
控制器函数名称：repaymentController
参数：repayaccount
api:count/repayaccount
*-*/
app.controller('repaymentController',['$rootScope','$scope','$routeParams','commonService','baseService',function($rootScope,$scope,$routeParams,wkindex,service){
  wkindex.loadAction({
    url: $rootScope.URL_ROOT+"/count/repayaccount"
  },$scope).success(function(response){
  /* console.log(response);*/
    $scope.repays=response.entity;
  });
  /*=分页列表=*/
  wkindex.loadPageAction({
    url: $rootScope.URL_ROOT+"/count/repayinfo"
  },$scope).success(function(response){
  /* console.log(response);*/
    $scope.repats=response.list;
  });
    if (!preMultiExec($scope)) return;
    service.initValue($scope);

    ps = $rootScope.pageSize;

    $scope.loadMore = function() {
        service.loadMore($scope, "/count/repayinfo", "repats", ps);
    }

  }

]);
